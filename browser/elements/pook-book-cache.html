<link href="../vendor/polymer/polymer.html" rel="import">

<link rel="import" href="pook-book-proxy.html">

<!--
@element pook-book-cache
@group model
Cache of pook-book-proxy elements

-->

<polymer-element name="pook-book-cache">
  <template></template>
  <script>
  "use strict";
  (function() {
  var Singleton = {
    books: {} // "$bookId" -> <pook-book-proxy>
  }
  Polymer({
    publish: {
      /**
       * @property books
       * @type Map
       * "$bookId" -> `<pook-book-proxy>`
       */
      books: null
    },
    created: function() {
      this.books = Singleton.books;
    },
    /**
     * @method getBook
     * @param {String} id bookId, if null, returns null
     * Returns pook-book-proxy. After fetch, 
     * also accessible through books[id] for template use.
     */
    getBook: function(id) {
      if (!id) return null;
      if (!(id in this.books)) {
        this.books[id] = document.createElement('pook-book-proxy');
        this.books[id].bookId = id;
      }
      return this.books[id];
    },
    /**
     * @method createBook
     * @param {String} ownerId owner user id
     * @param {String} title title
     * @param {Object} size size.width, size.height in inches
     * @param {Function} callback fn(err, bookRef)
     *
     * creates new book inside /books/$bookId. Use user.creawteBook for complete assignment
     */
    createBook: function(ownerId, title, size, callback) {
      var json = {
        createdAt: Firebase.ServerValue.TIMESTAMP,
        owner: ownerId,
        title: title,
        width: size.width,
        height: size.height
      }
      var db = new Firebase( CommonUtils.getFirebaseUrl('allBooks'));
      var bookRef = db.push(json, function(err) {
        if (err)
          return callback(err);
        var book = this.getBook(bookRef.key());
        book.bookIdChanged(); // force loading of Firebase, cant wait for observe propagation
        book.locationChanged();
        book.createInitialPages(function(err) {
          if (err) {
            book.remove();
            callback(err);
          }
          else
            callback(null, bookRef);
        }.bind(this));       
      }.bind(this));
    }
  });
  })();
  </script>
</polymer-element>
