<link href="../vendor/polymer/polymer.html" rel="import">
<link href="../vendor/core-drawer-panel/core-drawer-panel.html" rel="import">
<link href="../vendor/core-header-panel/core-header-panel.html" rel="import">
<link href="../vendor/core-item/core-item.html" rel="import">
<link href="../vendor/core-menu/core-menu.html" rel="import">
<link href="../vendor/core-pages/core-pages.html" rel="import">
<link href="../vendor/core-toolbar/core-toolbar.html" rel="import">
<link href="../vendor/paper-icon-button/paper-icon-button.html" rel="import">
<link href="../vendor/paper-item/paper-item.html" rel="import">

<link href="pook-fire-user.html" rel="import">
<link href="pook-page-account.html" rel="import">
<link href="pook-page-books.html" rel="import">
<link href="pook-page-security.html" rel="import">
<link href="pook-page-photos.html" rel="import">

<polymer-element name='pook-main-app'>
  <template>
   <style>    
      core-toolbar, core-toolbar::shadow .toolbar-tools {
        height: 36px;
      }
      [drawer] {
        background-color: #E9EDEF;
      }
      paper-item.core-selected::shadow div {
        font-weight: bold;
      }
      core-header-panel[main] /deep/ #mainContainer {
        display: flex;
        display: -webkit-flex;
      }
      .content {
        display: flex;
        display: -webkit-flex;
        flex: 1;
        -webkit-flex: 1;
        overflow: hidden;
      }
      core-pages {
        flex: 1;
        -webkit-flex: 1;
        display: flex;
        display: -webkit-flex;
      }
      core-pages > * {
        overflow: scroll;
      }
      paper-item /deep/ #label {  /* prevents 'tiny icons' problem */
        flex: 0;
      }
      core-menu {
        margin: 12px 0;
      }

    </style>

    <pook-fire-user id='user' anonRedirect='/'></pook-fire-user>
    <pook-body-file-drop on-file-dropped='{{fileDropped}}'></pook-body-file-drop>
    <core-drawer-panel id='drawerPanel' drawerWidth="8em">
      <core-header-panel drawer>
        <core-toolbar></core-toolbar>
        <core-menu id='menu' on-core-select="{{selectPane}}" selected="0">
          <paper-item icon='account-box' label='account'></paper-item>
          <paper-item icon='https' label='security'></paper-item>
          <paper-item icon='drive-drawing' label='photos'></paper-item>
          <paper-item icon='content-copy' label='books'></paper-item>
        </core-menu>
      </core-header-panel>
      <core-header-panel flex main>
        <core-toolbar>
          <paper-icon-button id="navicon" 
            icon="menu" 
            on-down="{{toggleDrawer}}" 
            style="display:{{$.drawerPanel.narrow ? 'inline-block' : 'none'}}"
          ></paper-icon-button>
          <span flex>{{tabTitle}}</span>
          <span flex>pook.io</span>
          <paper-button on-click='{{logout}}'>logout</paper-button>
        </core-toolbar>
        <div class='content'>
          <core-pages id='pages' selected='{{$.menu.selected}}'>
            <pook-page-account hashbang='account'></pook-page-account>
            <pook-page-security hashbang='security'></pook-page-security>
            <pook-page-photos hashbang='photos'></pook-page-photos>
            <pook-page-books hashbang='books'></pook-page-books>
          </core-pages>
        </div>
      </core-header-panel>
    </core-drawer-panel>
  </template>
  <script>
  Polymer({
    publish: {
      titleJigger: 0
    },
    computed: {
      tabTitle: "computeTabTitle($.menu.selected, titleJigger)"
    },
    ready: function() {
      this.selectPaneByHash();
    },
    computeTabTitle: function(tabId) {
      if (tabId === -1 || tabId === undefined )
        return "";
      return this.$.menu.children.item(tabId).label;
    },
    selectPaneByHash: function() {
      if (!window.location.hash)
        return;
      var hashbang = window.location.hash.slice(1);
      var bookMatch = hashbang.match(/^book:(.*)/); // handle book:$bookId hashes
      if (bookMatch) {
        this.editBook(bookMatch[1]);
      }
      else {
        var tabId = this.findTabById( window.location.hash.slice(1));
        if (tabId != -1)
          this.$.menu.selected = tabId;
      }
    },
    selectPane: function(ev, detail) {
      window.location.hash = ev.detail.item.hashbang || ev.detail.item.label; // book editors use hash
      this.$.drawerPanel.closeDrawer();
    },
    logout: function() {
      this.$.user.logout();
    },
    toggleDrawer: function() {
      this.$.drawerPanel.togglePanel();
    },
    fileDropped: function(ev) {
      this.$.user.createPhoto(ev.detail);
    },
    bookIdToHashbang: function(bookId) {
      return 'book:' + bookId;
    },
    // returns index, or -1
    findTabById: function(tabId) {
      var tab = this.$.pages.querySelector('[hashbang=\'' + tabId + '\']');
      if (tab)
        for (var i=0; i<this.$.pages.children.length; i++)
          if (this.$.pages.children.item(i) === tab)
            return i;
      return -1;
    },
    editBook: function(bookId) {
      var hashbang = this.bookIdToHashbang(bookId);
      var tabIndex = this.findTabById(hashbang);
      if (tabIndex != -1) {
        this.$.menu.selected = tabIndex;
        return;
      }
      // opens up an editor
      var paperItem = document.createElement('paper-item');
      paperItem.icon = 'drive-document';
      paperItem.setAttribute('hashbang', hashbang);
      paperItem.hashbang = hashbang;
      var bookEditorPage = document.createElement('pook-page-book-editor');
      bookEditorPage.setAttribute('hashbang', hashbang);
      bookEditorPage.bookId = bookId;
      // insert elements
      this.$.menu.insertBefore(paperItem, null);
      this.$.pages.insertBefore(bookEditorPage, null);
      this.$.menu.selected = this.$.menu.children.length - 1;

      // load the book title from firebase, remove the book on fail
      var bookRef = new Firebase(this.$.user.getDatabaseUrl('oneBook', bookId));
      var THIS = this;

      function removeBook() {
        paperItem.remove();
        bookEditorPage.remove();
        THIS.$.menu.selected = THIS.findTabById('books');
        document.querySelector('pook-flash').error = "book could not be loaded: " + bookId;
      }

      bookRef.once('value', 
        function success(snapshot) {
          bookJs = snapshot.val();
          if (bookJs) {
            paperItem.setAttribute('label', bookJs.title);
            THIS.titleJigger++;
          } 
          else
            removeBook();
        },
        function fail() {
          removeBook();
        }
      );
    }
  });
  </script>
</polymer-element>

