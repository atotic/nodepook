<link href="../vendor/polymer/polymer.html" rel="import">
<link href='../vendor/paper-button/paper-button.html' rel='import'>
<link href='pook-user.html' rel='import'>

<!--
  pook-page-photos displays all the user's photos

  @element pook-page-photos
-->

<polymer-element name='pook-page-photos'>
  <template>
    <style>
      .photoDiv {
        display: inline-block;
        margin: 2px;
        position: relative;
      }
      .photoDiv > .info {
        position: absolute;
        bottom: 4px;
        width: 100%;
        color: orange;
        text-align: right;
        text-shadow: black 0.1em 0.1em 0.2em;
        text-overflow: ellipsis;
        overflow:hidden;
      }
      .photoDiv > img {
        position: relative;
      }
      .photoDiv /deep/ progress {
        position: absolute;
        top: 8px;
        width: 100%;
        height: 12px;
      }
      #addPhotoInput {
        position:absolute;
        width:0px;
        height:0px;
        border:0;
        padding:0;
        margin:0
      }

    </style>
    <input id="addPhotoInput" type="file" multiple="true" accept="image/*" capture="filesystem">
    <paper-button on-click='{{clickAddPhoto}}' raised>upload more</paper-button>
    <p> Here are all your photos</p>
    <template id="photoList" repeat="{{k in photoIds}}">
      {{ requestPhotoProxy(k) }}
      <template bind="{{calculateIconDims(user.photoCache.cache[k].iconInfo, iconHeight) as info}}">
        <div class='photoDiv'>
          <img src="{{info.src}}" width="{{info.width}}" height="{{info.height}}"></img>
          <div class='info'>
            {{user.photoCache.cache[k].data.displayName}}
          </div>
          <template if="{{user.photoCache.cache[k].progress != -1}}">
            <progress value="{{user.photoCache.cache[k].progress}}"></progress>
          </template>
        </div>
      </template>
   </template>
  </template>
  <style>
  </style>
  <script>
  "use strict";
  Polymer({
    publish: {
      user: null,
      iconHeight: 196,
      photoIds: []
    },
    created: function() {
      this.user = document.createElement('pook-user');
      var THIS = this;
      this.user.requestDatabase('userPhotos').then( function(database) {
        database.addEventListener('data-change', THIS.userPhotosChanged.bind(THIS));
      });
      this.async(this.startScrollingToUpdates, null, 500);
    },
    ready: function() {
      this.$.addPhotoInput.addEventListener('change', this.handleAddPhotoInput.bind(this));
    },
    startScrollingToUpdates: function() {
      if (!this.scrollingToUpdates) {
        this.scrollingToUpdates = true;
        this.onMutation(this.shadowRoot, this.childrenUpdated);
      }
    },
    childrenUpdated: function(observer, mutations) {
      var target = PookUtils.mutationsFindAddedNode( mutations, function(node) {
          return node.className && node.className.match(/photoDiv/);
      });
      if (target)
        PookUtils.scrollIntoView(target, this);
      if (this.scrollingToUpdates) {
        this.onMutation(this.shadowRoot, this.childrenUpdated);
      }
    },
    userPhotosChanged: function() {
      if (!this.scrollingToUpdates)
        this.job('startScrollingToUpdates', 
          this.startScrollingToUpdates.bind(this), 
          500);
      if (this.user.userPhotos)
        this.photoIds = Object.keys(this.user.userPhotos).reverse();
      else
        this.photoIds = [];
    },
    clickAddPhoto: function() {
      this.$.addPhotoInput.click();
    },
    handleAddPhotoInput: function(ev) {
      console.log("files added");
      for (var i=0; i<this.$.addPhotoInput.files.length; i++)
        this.user.createPhoto(this.$.addPhotoInput.files.item(i));
    },
    requestPhotoProxy: function(photoId) {
      this.user.photoCache.requestProxy(photoId);
    },
    calculateIconDims: function(iconInfo, iconHeight) {
      var enclosure = new Rect({width: iconHeight * 1.33, height: iconHeight });
      var iconRect = new Rect( iconInfo);
      iconRect = iconRect.scaleBy(iconRect.fitInside(enclosure));
      return {
        src: iconInfo.src,
        width: iconRect.width,
        height: iconRect.height
      }
    }
  });
  </script>
</polymer-element> 
