<link rel="import" href="../vendor/polymer/polymer.html">

<link rel="import" href="pook-book-cache.html">
<link rel="import" href="firebaseTransaction.html">
<!--
/**
  * Book editor 
  *
  * @element pook-page-book-editor
  * @group ui
  */
-->
<polymer-element name='pook-page-book-editor'>
  <template>
    <style>
      :host {
        background-color: #dddddd;
        background-image: url('/img/back.png');
      }
      #pages {
        display: flex;
        display: -webkit-flex;
                flex-flow: wrap;
        -webkit-flex-flow: wrap;
        margin: 16px 16px 0 16px;
      }
      pook-page-icon {
        margin-top: 16px;
        margin-bottom: 8px;
      }
      pook-page-icon[pageSide="left"] {
        margin-left: 6px;
      }
      pook-page-icon[pageSide="right"] {
        margin-right: 6px;
      }
      .hidden {
        visibility: hidden;
      }

    </style>
    <section id="pages">
      <template repeat="{{s in book.sheetIds}}">
        <pook-page-icon orientation="left" 
          page="{{book.pages[ book.sheets[s].left]}}"
          style="{{simplePageStyle | styleObject}}"
          ></pook-page-icon>
        <pook-page-icon orientation="right" 
          page="{{book.pages[ book.sheets[s].right]}}"
          style="{{simplePageStyle | styleObject}}"
          ></pook-page-icon>
      </template>
    </section>
    <paper-button 
      on-tap="{{morePages}}" 
      disabled="{{!book.canAddPages}}"
      raised>{{book.pageCountIncrement}} more pages</paper-button>
    <paper-button 
      on-tap="{{fewerPages}}" 
      disabled="{{!book.canRemovePages}}"
      raised>{{book.pageCountIncrement}} fewer pages</paper-button>
  </template>
  <script>
  (function() {
    "use strict";

    var Singleton = {
      get bookCache() {
        if (!('_bookCache' in this))
          this._bookCache = document.createElement('pook-book-cache');
        return this._bookCache;
      }
    };

    Polymer({
      publish: {
        /**
         * @property bookId
         * @type string
         * id of the edited book
         */
        bookId: null,
        // how wide should pook-page-icon be
        desiredPageWidth: 0,
      },
      computed: {
        sheets: "computeSheets( book.sheetIds)",
        simplePageStyle: "computeSimplePageStyle(desiredPageWidth, book.data.width, book.data.height)"
      },

      book: null,

      attached: function() {
        this.calcPageDimensions();
        this._boundResizer = function() {
          this.job('resizer', this.calcPageDimensions, 100);
        }.bind(this);
        window.addEventListener('resize', this._boundResizer);
      },
      detached: function() {
        if (this._boundResizer)
          window.removeEventListener('resize', this._boundResizer);
      },

      bookIdChanged: function() {
        this.book = Singleton.bookCache.getBook(this.bookId);
      },

      computeSheets: function(ids) {
        if (this.book)
          this.book.loadAllPages();
        return ids;
      },

      computeSimplePageStyle: function(pageWidth, bookWidth, bookHeight) {
        // console.log("computeSimplePageStyle", pageWidth);
        if (pageWidth && bookWidth && bookHeight)
          return {
            width: pageWidth + "px",
            height: (pageWidth * bookHeight / bookWidth) + "px"
          }
        else
          return {
            width: "100px",
            height: "100px"
          }
      },

      calcPageDimensions: function() {
        function computePageWidth(sheets) {
          var space = pageListWidth;
          space -= (sheets) * 2 * 6;  // pook-page-icon.margin-left + pook-page-icon.margin-right
          return Math.trunc(space / sheets / 2);
        }

        var myStyle = window.getComputedStyle(this);
        var s = window.getComputedStyle(this.$.pages);

        var pageListWidth = parseInt(s.getPropertyValue('width'));
        var myHeight = parseInt(myStyle.getPropertyValue('height'));

        var pageWidths = [];
        // find page widths for different number of sheets
        for (var i=1; i<12; i++)
          pageWidths[i] = computePageWidth(i);

        var pick = 3;
        var minDesired = 128;
        var maxDesired = 256;
        // if page is too small, fit fewer
        while(pick > 1 && pageWidths[pick] < minDesired)
          pick = pick -1;
        // if page is too big, fit more
        while(pick < 11 && pageWidths[pick] > maxDesired)
          pick = pick + 1;
        this.desiredPageWidth = pageWidths[pick];
      },

      morePages: function() {
        var transaction = new FirebaseTransaction('addPages');
        this.book.addPages(transaction);
        transaction.resolve( function(err) {
          if (err) {
            console.error("addPages", err);
            document.querySelector('pook-flash').error("unexpected error adding pages");
          }
        });
        console.warn("should scroll to end");
      },

      fewerPages: function() {
        var transaction = new FirebaseTransaction('removePages');
        this.book.removePages(transaction);
        transaction.resolve( function(err) {
          if (err) {
            console.error("removePages", err);
            document.querySelector('pook-flash').error("unexpected error removing pages");
          }
        });
      }
    });
  })();
  </script>
</polymer-element>

<!--
@element pook-page-icon
@group ui

Displays icon for the page.

Parent should set icon width & height in css

-->
<polymer-element name="pook-page-icon">
  <template>
    <style>
      :host {
        display: inline-block;
        border: 1px solid black;
        background-color: white;
        overflow: hidden;
      }
      :host([pageSide="left"]) {
        border: 2px solid #ffffff;
        border-right: 1px solid #dddddd;
        box-shadow: -2px 0px 4px #b3b3b3;      
      }
      :host([pageSide="right"]) {
        border: 2px solid #ffffff;
        border-left: 1px solid #dddddd;
        box-shadow: 2px 0px 4px #B3B3B3;
      }
      #frame {
      }
    </style>
      <div id="frame">
        {{pageSide}}
      </div>
  </template>
  <script>
    Polymer({
      publish: {
        /**
         * @attribute orientation
         * @type left|right|none
         * applies appropriate page shadows
         */
        orientation: "",
        /**
         * @attribute page
         * @type pook-page-proxy
         * page to be shown. if null, element gets visibility:hidden
         */
        page: null
      },
      ready: function() {
        this.setAttribute('pageSide', this.orientation);
        this.pageChanged();
      },
      pageChanged: function() {
        if (!this.page) // hide non-existent pages
          this.classList.add('hidden');
        else
          this.classList.remove('hidden');
      }
    });
  </script>
</polymer-element>
