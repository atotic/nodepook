<link rel="import" href="../vendor/polymer/polymer.html">
<link rel="import" href="../vendor/paper-button/paper-button.html">
<link rel="import" href="../vendor/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../vendor/core-icons/core-icons.html" >
<link rel="import" href="../vendor/core-icons/social-icons.html" >

<link rel="import" href="pook-user.html">
<link rel="import" href="pook-new-book-dialog.html">
<link rel="import" href="pook-share-book-dialog.html">
<link rel="import" href="pook-book-icon.html">
<link rel="import" href="pook-utils.html">
<!--
/**
  * Book listing and actions
  *
  * @element pook-page-books
  # @group ui
  */
-->
<polymer-element name='pook-page-books'>
  <template>
    <core-style ref='pook-animations'></core-style>
    <style>
      :host {
        display: flex;
        display: -webkit-flex;
        flex-direction: column;
        -webkit-flex-direction: column;
      }
      .book-tile {
        cursor: pointer;
      }
      .book-tile.animate-add {
        z-index: 999;
        background-color: white;
        -webkit-animation-duration:0.5s;
                animation-duration:0.5s;
        -webkit-animation-name:slide-up;
                animation-name:slide-up;
      }
      .book-tile.animate-remove {
        -webkit-animation-duration:0.5s;
                animation-duration:0.5s;
        -webkit-animation-name:fade-out;
                animation-name:fade-out;    
      }
      #selectorContainer {
        flex: 1;
        -webkit-flex: 1;
        overflow: scroll;
      }
      .book-list {
        margin: 12px;
        display: flex;
        display: -webkit-flex;
        flex-flow: wrap;
        -webkit-flex-flow: wrap;
        align-items: flex-end;
        -webkit-align-items: flex-end;
        flex-direction: row;
        -webkit-flex-direction: row;
      }
      core-toolbar, core-toolbar::shadow .toolbar-tools {
        height: 36px;
        overflow:hidden;
      }
    </style>
    <div id='selectorContainer' on-tap='{{clearSelection}}'>
      <section id="myBooks" class="book-list">
        <div style="padding:0 8px 0 4px; width: 100px; height: 100px; position:relative">
          <paper-button on-tap="{{showNewBookDialog}}" raised style="position:absolute; bottom:10px;">Start a new book...</paper-button>
        </div>
        <template id="bookList" repeat="{{k in bookIds}}">
          <pook-book-icon bookId="{{k}}"
            class="book-tile {{ k | computeTileClass }}"
            on-tap="{{bookTapHandler}}"
            on-animationend="{{handleTileAnimationEnd}}" 
            on-webkitAnimationEnd="{{handleTileAnimationEnd}}"  
            on-mozAnimationEnd="{{handleTileAnimationEnd}}"
           ></pook-book-icon>
        </template>
      </section>
      <section id="sharedBooks">
        <template if="{{booksSharedWithMeIds.length > 0}}">
          <p>Books shared with me</p>
          <div class="book-list">
            <template repeat="{{k in booksSharedWithMeIds}}">
              <pook-book-icon bookId="{{k}}"
                sharedWithMe
                class="book-tile"
                on-tap="{{bookTapHandler}}"
              ></pook-book-icon>
            </template>
          </div>
        </template>
      </section>
    </div>
    <core-toolbar>
      <paper-button style='min-width:0' on-tap="{{editBook}}" disabled?="{{!bookSelection}}">edit</paper-button>
      <paper-icon-button icon="social:share" on-tap="{{showShareBookDialog}}" disabled?="{{!bookSelection}}"></paper-icon-button>
      <span flex></span>
      <paper-icon-button icon="delete" on-tap="{{deleteBook}}" disabled?="{{!bookSelection}}"></paper-icon-button>
    </core-toolbar>
  </template>
  <script>

  Polymer( {
    publish: {
      bookIds: [],
      booksSharedWithMeIds: [],
      bookSelection: null
    },
    computed: {
      booksSharedWithMeIds: "computeSharedWithMeIds( user.booksSharedWithMeDb.keys)"
    },
    created: function() {
      this.delta = {
        add: {}, // # key => true
        remove: {} // # key => index in old array
      };

      this.user = document.createElement('pook-user');
      this.user.myBooksDb.addEventListener('data-change', this.booksChanged.bind(this));
    },
    computeSharedWithMeIds: function( ids) {
      if (!ids) return [];
      ids.forEach( this.user.bookCache.getBook.bind(this.user.bookCache) );
      return ids;
    },
    setSelection: function(item) {
      if (this.bookSelection)
        this.bookSelection.classList.remove('core-selected');
      this.bookSelection = item;
      if (item)
        item.classList.add('core-selected');
    },
    clearSelection: function(ev) {
      // clear selection on taps outside books
      if (!ev || ev.target === this.$.selectorContainer)
        this.setSelection(null);
    },
    bookTapHandler: function(ev) {
      if (ev.detail === 1) // select book
        this.setSelection(ev.currentTarget);
      if (ev.detail === 2) // double-tap
        this.editBook();
    },
    showNewBookDialog: function() {
      var dialog = document.createElement('pook-new-book-dialog');
      this.shadowRoot.appendChild(dialog);
    },
    showShareBookDialog: function() {
      var shareDialog = document.createElement('pook-share-book-dialog');
      shareDialog.bookId = this.bookSelection.bookId;
      this.shadowRoot.appendChild(shareDialog);
    },
    deleteBook: function() {
      var bookId = this.bookSelection.bookId;
      if ( this.bookIds.indexOf( bookId) >= 0)   // my book, delete
        this.user.deleteBook( this.bookSelection.bookId );
      else
        this.bookSelection.getBook().stopShare(this.user.uid);
      this.clearSelection();
    },
    editBook: function() {
      document.querySelector('pook-app').editBook( this.bookSelection.bookId );
    },
    findTemplateInstanceByKey: function(k) {
      var instances = this.$.bookSelector.querySelectorAll('.book-tile');
      for (var i=0; i<instances.length; i++)
        if (instances.item(i).templateInstance.model.k === k)
          return instances.item(i);
    },
    computeBookIds: function() {
      if (!this.user.myBooks)
        return [];
      else {
        var ids = Object.keys( this.user.myBooks ).reverse();
        ids.forEach( this.user.bookCache.getBook.bind(this.user.bookCache));
        return ids;
      }
    },
    computeDelta: function(newKeys, oldKeys) {
      var newHash = PookUtils.arrayToHash( newKeys );
      var oldHash = PookUtils.arrayToHash( oldKeys );
      var delta = {
        add: this.delta.add,
        remove: {}
      };
      if (oldKeys.length == 0)  // initial animation
        return delta;
      for (var k in newHash) {
        if ( k in oldHash )
          delete oldHash[k];
        else
          delta.add[k] = true;
      }
      // keys deleted from newHash are still in oldHash
      for (var k in oldHash)
        delta.remove[k] = oldHash[k];
      return delta;
    },
    computeTileClass: function(k) {
      if (k in this.delta.remove)
        return 'animate-remove';
      if (k in this.delta.add)
        return 'animate-add';
      return '';
    },
    booksChanged: function() {
      var newIds = this.computeBookIds();
      this.delta = this.computeDelta(newIds, this.bookIds);
      // reinsert deleted keys for animation, keeping the position
      var removes = [];
      for (var k in this.delta.remove)
        removes.push({ id: k, index: this.delta.remove[k]});
      removes.sort( function(a,b) { return a.index - b.index });
      removes.forEach( function(r) { newIds.splice( r.index, 0, r.id)});
      // kick off remove animation
      for (var i=0; i<removes.length; i++) {
        var el = this.findTemplateInstanceByKey( removes[i].id);
        if (!el)
          console.error('could not find deleted element');
        el.classList.add('animate-remove');
      }
      // finally, assign new keys
      this.bookIds = newIds; 
    },
    handleTileAnimationEnd: function(ev) {
      var target = ev.currentTarget;
      var key = target.templateInstance.model.k;
      var classTag = target.classList.contains('animate-remove') ? 'animate-remove' :
                      target.classList.contains('animate-add') ? 'animate-add' : "";
      // remove class tag
      ev.currentTarget.classList.remove(classTag);
      // remove from delta list
      delete this.delta[ classTag.replace('animate-', '')][key];
      switch (classTag) {
        // removed 
        case 'animate-remove':
          // remove item from the the list of actives
          this.bookIds.splice(this.bookIds.indexOf(key), 1);
          break;
        default:
          break;
      }
    }
  });
  </script>
</polymer-element>

