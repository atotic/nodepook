<link href="../vendor/polymer/polymer.html" rel="import">
<link href="../vendor/paper-button/paper-button.html" rel="import">
<link href="../vendor/core-selector/core-selector.html" rel="import">
<link href="../vendor/paper-icon-button/paper-icon-button.html" rel="import">
<link href="../vendor/core-icons/core-icons.html" rel="import">
<link href="../vendor/core-icons/social-icons.html" rel="import">

<link href="pook-user.html" rel="import">

<!--
/**
  * Book listing 
  *
  * @element pook-page-books
  # @category ui
  */
-->
<polymer-element name='pook-page-books'>
  <template>
    <core-style ref='pook-animations'></core-style>
    <style>
      .book-tile {
        position: relative;
        width: 50px;
        height: 50px;
        border: 1px solid #555;
        vertical-align: bottom;
        margin: 8px;
        padding: 8px;
        overflow: hidden;
        text-overflow: ellipsis;
        user-select: none;
        -webkit-user-select: none;
        cursor: pointer;
      }
      .book-tile.core-selected:after {
        position: absolute;
        content: "\2713";
        text-align: left;
        bottom: 4px;
        right: 4px;

        border: 1px solid #aaa;
        width: 20px;
        height: 20px;
        border-radius: 10px;
        background-color: #0BA8F2;
        color: #DDD;
      }
      .book-tile.animate-add {
        z-index: 999;
        background-color: white;
        -webkit-animation-duration:0.5s;
                animation-duration:0.5s;
        -webkit-animation-name:slide-up;
                animation-name:slide-up;
      }
      .book-tile.animate-remove {
        -webkit-animation-duration:0.5s;
                animation-duration:0.5s;
        -webkit-animation-name:fade-out;
                animation-name:fade-out;    
      }

      :host {
        display: flex;
        display: -webkit-flex;
        flex-direction: column;
        -webkit-flex-direction: column;
      }
      #selectorContainer {
        flex: 1;
        -webkit-flex: 1;
        overflow: scroll;
      }
      #bookSelector {
        display: flex;
        display: -webkit-flex;
        flex-flow: wrap;
        -webkit-flex-flow: wrap;
        align-items: flex-end;
        -webkit-align-items: flex-end;
        flex-direction: row;
        -webkit-flex-direction: row;
        margin: 12px;
      }
      core-toolbar, core-toolbar::shadow .toolbar-tools {
        height: 36px;
        overflow:hidden;
      }
    </style>
    <pook-dialog-new-book id='newBookDialog'></pook-dialog-new-book>
    <div id='selectorContainer' on-tap='{{clearSelection}}'>
      <core-selector id='bookSelector' touch-action="none" >
        <div style="padding:0 8px 0 4px; width: 100px; height: 100px; position:relative">
          <paper-button on-tap="{{showNewBookDialog}}" raised style="position:absolute; bottom:10px;">Start a new book...</paper-button>
        </div>
        <template id="bookList" repeat="{{k in bookIds}}">
            <div layout vertical 
              class="book-tile {{ k | computeTileClass }}"
              style="width:{{user.userBooks[k].info.width * 8}}px;height:{{user.userBooks[k].info.height*8}}px" 
              on-tap="{{bookTapHandler}}"
              on-animationend="{{handleTileAnimationEnd}}" 
              on-webkitAnimationEnd="{{handleTileAnimationEnd}}"  
              on-mozAnimationEnd="{{handleTileAnimationEnd}}"
            >
              <p>{{user.userBooks[k].title}}</p>
            </div>
        </template>
      </core-selector>
    </div>
    <core-toolbar>
      <paper-button style='min-width:0' on-tap="{{editBook}}" disabled?="{{$.bookSelector.selectedIndex === -1}}">edit</paper-button>
      <paper-icon-button icon="social:share" on-tap="{{shareBook}}" disabled?="{{$.bookSelector.selectedIndex === -1}}"></paper-icon-button>
      <span flex></span>
      <paper-icon-button icon="delete" on-tap="{{deleteBook}}" disabled?="{{$.bookSelector.selectedIndex === -1}}"></paper-icon-button>
    </core-toolbar>
  </template>
  <script>

  Polymer( {
    publish: {
      user: null,
      bookIds: [],
      delta: {
        add: {}, // # key => true
        remove: {} // # key => index in old array
      },
    },
    created: function() {
      this.user = document.createElement('pook-user');
      var THIS = this;
      this.user.requestDatabase('userBooks')
        .then( function(database) {
          database.addEventListener('data-change', THIS.booksChanged.bind(THIS));
        });
    },
    clearSelection: function(ev) {
      // clear selection on taps outside books
      if (ev.target === this.$.selectorContainer)
        this.$.bookSelector.selected = null;
    },
    bookTapHandler: function(ev) {
      if (ev.detail === 2) // double-tap
        this.editBook();
    },
    showNewBookDialog: function() {
      this.$.newBookDialog.toggle();
    },
    deleteBook: function() {
      if (this.$.bookSelector.selectedIndex === -1)
        return;
      this.user.deleteBook( this.bookIds[this.$.bookSelector.selectedIndex - 1]);
      this.$.bookSelector.selected = null;
    },
    editBook: function() {
      document.querySelector('pook-app').editBook( this.bookIds[this.$.bookSelector.selectedIndex - 1]);
    },
    shareBook: function() {
      console.log('TODO');
    },
    findTemplateInstanceByKey: function(k) {
      var instances = this.$.bookSelector.querySelectorAll('.book-tile');
      for (var i=0; i<instances.length; i++)
        if (instances.item(i).templateInstance.model.k === k)
          return instances.item(i);
    },
    computeBookIds: function() {
      if (!this.user.userBooks)
        return [];
      else
        return Object.keys( this.user.userBooks ).reverse();
    },
    computeDelta: function(newKeys, oldKeys) {
      var newHash = PookUtils.arrayToHash( newKeys );
      var oldHash = PookUtils.arrayToHash( oldKeys );
      var delta = {
        add: this.delta.add,
        remove: {}
      };
      if (oldKeys.length == 0)  // initial animation
        return delta;
      for (var k in newHash) {
        if ( k in oldHash )
          delete oldHash[k];
        else
          delta.add[k] = true;
      }
      // keys deleted from newHash are still in oldHash
      for (var k in oldHash)
        delta.remove[k] = oldHash[k];
      return delta;
    },
    computeTileClass: function(k) {
      if (k in this.delta.remove)
        return 'animate-remove';
      if (k in this.delta.add)
        return 'animate-add';
      return '';
    },
    booksChanged: function() {
      var newIds = this.computeBookIds();
      this.delta = this.computeDelta(newIds, this.bookIds);
      // reinsert deleted keys for animation, keeping the position
      var removes = [];
      for (var k in this.delta.remove)
        removes.push({ id: k, index: this.delta.remove[k]});
      removes.sort( function(a,b) { return a.index - b.index });
      removes.forEach( function(r) { newIds.splice( r.index, 0, r.id)});
      // kick off remove animation
      for (var i=0; i<removes.length; i++) {
        var el = this.findTemplateInstanceByKey( removes[i].id);
        if (!el)
          console.error('could not find deleted element');
        el.classList.add('animate-remove');
      }
      // finally, assign new keys
      this.bookIds = newIds; 
    },
    handleTileAnimationEnd: function(ev) {
      var target = ev.currentTarget;
      var key = target.templateInstance.model.k;
      var classTag = target.classList.contains('animate-remove') ? 'animate-remove' :
                      target.classList.contains('animate-add') ? 'animate-add' : "";
      // remove class tag
      ev.currentTarget.classList.remove(classTag);
      // remove from delta list
      delete this.delta[ classTag.replace('animate-', '')][key];
      switch (classTag) {
        // removed 
        case 'animate-remove':
          // remove item from the the list of actives
          this.bookIds.splice(this.bookIds.indexOf(key), 1);
          break;
        default:
          break;
      }
    }
  });
  </script>
</polymer-element>

