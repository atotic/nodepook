<link rel='import' href='/vendor/paper-input/paper-input.html'>
<link rel='import' href='/vendor/paper-button/paper-button.html'>
<link rel='import' href='/vendor/firebase-elements/firebase-element.html'>
<link rel='import' href='/vendor/firebase-elements/firebase-login.html' >
<link rel='import' href='/views/el/pook-fire-user.html'>
<style>
  * /deep/ .heading { 
    background-color: #DDD 
  }
  * /deep/  table {
    border-collapse: separate;
    border-width: 1px;
    border-spacing: 2px;
  }
  * /deep/ th, * /deep/ td {
    padding: 0.25rem;
    text-align: left;
    border: 1px solid #ccc;
  }

</style>
<polymer-element name='test-globals'>
  <template>
    <template if="{{visible}}">
      <p class='heading'>test-globals</p>
      <table>
        <tr>
          <td>editable firstName</td>
          <td><paper-input value="{{firstName}}" ></paper-input></td>
        </tr>
        <tr>
          <td>address.street</td>
          <td><paper-input value="{{address.street}}" ></paper-input></td>
        </tr>
        <tr>
          <td>address.sublet.tenant</td>
          <td><paper-input value="{{address.sublet.tenant}}" ></paper-input></td>
        </tr>
        <tr>
          <td>shared.kidOne</td>
          <td><paper-input value="{{shared.kidOne}}" ></paper-input></td>
        </tr>
        <tr>
          <td>this.firstName</td>
          <td>{{this.firstName}}</td>
        </tr>
        <tr>
          <td>firstName</td>
          <td>{{firstName}}</td>
        </tr>
        <tr>
          <td>fullName, computed</td>
          <td>{{fullName}}</td>
        </tr>
        <tr>
          <td>address</td>
          <td>{{address.street}} {{address.city}} {{address.sublet.tenant}}</td>
        </tr>
       <tr>
          <td>shared.kidOne</td>
          <td>{{shared.kidOne}}</td>
        </tr>
      </table>
    </template>
  </template>
  <script>
  (function() {
    var sharedProps = {
      kidOne: "Oliver"
    }
    Polymer('test-globals', {
      publish: {
        visible: false,
        firstName: "John Pub",
        lastName: "Smith",
        address: false,
        shared: false
      },
      computed: {
        fullName: 'firstName + " " + lastName'
      },
      observe: {
        'address.sublet.tenant' : 'tenantChanged'
      },
      created: function() {
        // console.log('created:', this.firstName);
        this.address = {
          street: "Long Lane",
          city: "Palo Alto",
          sublet: {
            tenant: "Andrew Suble"
          }
        }
        this.shared = sharedProps;
      },
      ready: function() {
        // console.log('ready:', this.firstName);
      },
      firstNameChanged: function() {
        console.log('changed: firstName ', this.firstName);
      },
      fullNameChanged: function() {
        // console.log('changed: fullName', this.fullName);
      },
      addressChanged: function() {
        console.log('changed: address')
      },
      tenantChanged: function(ev) {
        console.log('changed: tenant' );
      }
    });
/*
  simple properties:
  - declared
      polymer-element attributes='firstName lastName'
      publish attribute publish: { foo: 'foo', bar: { value: 'bar', reflect: }}
      reflection is off by default, use only if you need html attributes
  - initial value: 
     from declaration
       1) as html attribute, fires changed
     from element definition:
       2) polymer-element html attribute, fires changed
          must declare property in attributes, or priority unknown
       3) created() assignment
       4) publish block, does not fire changed. USE THIS
  - attribute values are converted to 'preferred' type. 
      json strings become objects, numbers be numbers
  computed properties
    - get changed event after ready
  object-valued properties
    - default values should be initialized in create() (otherwise shared state)
    - do not get changed events when modifying subproperties
    - bindings to nested properties works two-way
    - observes to nested properties must be explicitly declared:
      observe: { 'address.sublet.tenant' : 'tenantChanged'}
  templates
    repeat="{{s in array}}"
    bind="{{person as p}}" (p.name, )
    if="{{conditionalValue}}"
    - can import sub-templates by reference, make'em recursive
  bindings
    bind to text, creates text node
    bind to attributes
    attribute?={{boolean-expression}} conditional attributes
    two-way bindings only for published properties
  event handlers 
    on-click='{{handleClick}}'
    event handler expressions cannot reference other elements (ex: this.$.el.handler)
  auto-binding
    <template id="auto-bind-demo" is="auto-binding" repeat="{{quotes}}">
    have to initialize model with javascript

  misc:
    - use fire() to fire events
    - inherit from other elements with "extends" attribute
    - async(), setTimeout for dom manipulation
    - job(), setTimeout with duplicate call elimination
    - elements not in DOM get stripped {{}} & changed bindings. Call cancelUnbindAll to prevent. 
    - Platform.flush propagates data bindings immediately
*/
  })();
  </script>
</polymer-element>

<polymer-element name='test-event-handler'>
  <template>
    <p id='title'>Event handler</p>
  </template>
  <script>
    Polymer('test-event-handler', {
      changeColor: function(ev) {
        console.log('changeColor');
        this.$.title.style.backgroundColor = 'green';
      }
    });
  </script>
</polymer-element>

<polymer-element name='test-firebase'>
  <template>
    <template if='{{visible}}'>
      <p class='heading'>test-firebase</p>
      <table>
        <tr>
          <td>account.firstName</td>
          <td><paper-input label='firstName' value="{{databases['account'].data.firstName}}"></paper-input></td>
        </tr>
      </table>
    </template>
  </template>
  <script>
  "use strict";
  (function() {

    var gUserInfo = { 
      uid: '', 
      email: ''
    }

    var gDatabases = {
      account: false,
      user: false,
      userPhotos: false,
      allPhotos: false
    }

    var gFireLoc = 'https://torid-inferno-6070.firebaseio.com/';
    var gAuthClient;

    function init() {
      if (gAuthClient != null)
        return;
      gAuthClient = new FirebaseSimpleLogin( new Firebase(gFireLoc),
        function(err, user) {
        if (err)
          console.error(err);
        else {
          // console.log("got user", user);
          gUserInfo.uid = user ? user.uid : 'anonymous';
          gUserInfo.email = user ? user.email : '';
        }
      });
      gAuthClient.login('password', {
        email: 'b@totic.org', password: '12345678'
      });
    }

    init();

    Polymer('test-firebase', {
      /*
      firebase-element
        data object is observed for changes, and changes are reflected back to db using firebase api

      */
      publish: {
        visible: false,
        fireLoc: gFireLoc,
        userInfo: true,
        databases: false
      },
      computed: {
        uid: 'userInfo.uid',
        email: 'userInfo.email',
        account: "databases['account'].data"
      },
      observe: {
        uid: 'userStatusChanged'
      },
      created: function() {
        this.userInfo = gUserInfo;
        this.databases = gDatabases;
      },
      userStatusChanged: function() {
        console.log("userStatusChanged", this.uid);
        this.connectActiveDatabases();
      },
      requestDatabase: function(type) {
        if (!(type in this.databases))
          return console.error("bad database request", type);
        console.log('requestDatabase:', type);
        if (this.databases[type] === false)
          this.databases[type] = true;
        this.connectActiveDatabases();
      },
      connectActiveDatabases: function() {
        if (this.uid === 'anonymous' || this.uid === '') {
          // no user, remove active databases
          for (var k in this.databases)
            if ((typeof this.databases[k]) === 'object')
              this.databases[k] = true;
        }
        else {
          for (var k in this.databases)
            if (this.databases[k] === true) {
              this.databases[k] = document.createElement('firebase-element');
              this.databases[k].location = this.getDatabaseUrl(k);
            }
        }
      },
      getDatabaseUrl: function(type) {
        switch(type) {
          case 'user':
            return this.fireLoc + "users/" + this.uid;
          case 'account':
            return this.fireLoc + "users/" + this.uid + "/account";
          case 'userPhotos':
            return this.fireLoc + "users/" + this.uid + "/photos";
          case 'allPhotos':
            return this.fireLoc + "photos";
          default:
            console.error("unknown database type", type);
        }
      }
    });
  })();
  </script>
</polymer-element>

</polymer-element>
<polymer-element name='test-destination'>
  <template>
    <p class='heading'>test-destination</p>
    <paper-button on-click='{{$.evHandler.changeColor}}' label='$.evHandler.changeColor'></paper-button>
    <paper-button on-click='{{evHandler.changeColor}}' label='evHandler.changeColor'></paper-button>
    <paper-button on-click='{{changeColor}}' label='changeColor'></paper-button>
    <test-globals id='globalId'></test-globals>
    <test-event-handler id='evHandler'></test-event-handler>
    <test-firebase id='firebase'></test-firebase>
    <table>
      <tr>
        <td>$.globalId.firstName:</td>
        <td>{{$.globalId.firstName}}</td>
      </tr>
      <tr>
        <td>glob.firstName:</td>
        <td>{{glob.firstName}}</td>
      </tr>
      <tr>
        <td>glob.fullName:</td>
        <td>{{glob.fullName}}</td>
      </tr>
      <tr>
        <td>glob.address.sublet.tenant:</td>
        <td>{{glob.address.sublet.tenant}}</td>
      </tr>
      <tr>
        <td>glob.shared.kidOne:</td>
        <td>{{glob.shared.kidOne}}</td>
      </tr>
      <tr>
        <td>glob.shared.kidOne:</td>
        <td>{{glob.shared.kidOne}}</td>
      </tr>
      <tr>
        <td>$.firebase.databases['account'].data.firstName:</td>
        <td>{{$.firebase.databases['account'].data.firstName}}</td>
      </tr>
      <tr>
        <td>$.firebase.account.firstName:</td>
        <td>{{$.firebase.account.firstName}}</td>
      </tr>
    </table>
  </template>
  <script>
  "use strict";
  Polymer('test-destination', {
    ready: function() {
      this.glob = this.$.globalId;
      this.evHandler = this.$.evHandler;
      this.$.firebase.requestDatabase('account');
    },
    changeColor: function(ev) {
      debugger;
      console.log('changeColor: test-destination');
      this.$.evHandler.changeColor(ev);
    }
  });
  </script>
</polymer-element>

<polymer-element name='test-fire-observer'>
  <template>
    <p class='heading'>test-fire-observer</p>
    <paper-button label="add user photo" on-click='{{addUserPhoto}}' raisedButton></paper-button>
    <paper-button label="remove photo" on-click='{{removePhoto}}' raisedButton></paper-button>
    <template repeat="{{k, index in userPhotoKeys }}">
      <p>{{index}}:{{k}}</p>
    </template>
    <p>Explicit list</p>
    <li>{{idList.a}}</li>
    <li>{{idList.b}}</li>
    <li>{{idList.c}}</li>
    <li>{{idList.d}}</li>
  </template>
  <script>
    Polymer('test-fire-observer', {
      publish: {
        user: false,
        idList: false,
        forceRefilter: 0
      },
      computed: {
        userPhotoKeys: '{ obj: idList, force: forceRefilter} | keysToArray'
      },
      observe: {
        'userPhotoKeys': 'userPhotoKeysChanged'
      },
      created: function() {
        this.user = document.createElement('pook-fire-user');
        this.user.requestDatabase('userPhotos');
        this.idList = {
          a: true, b: true, c: true, d: true
        }
        this.observeIdList();
      },
      addUserPhoto: function() {
        this.idList[this.user.randomString(2)] = true;
      },
      removePhoto: function() {
        for (var k in this.idList)
          return delete this.idList[k];
      },
      keysToArray: function(o) {
        var retVal = [];
        for (var k in o.obj)
          retVal.push(k);
        console.log('keysToArray:', retVal);
        return retVal;
      },
      userPhotoKeysChanged: function() {
        console.log('userPhotoKeysChanged');
      },
      idListChanged: function() {
        console.log('idListChanged');
      },
      observeIdList: function() {
        if (!this.idList) {
          if (this.idListObserver)
            this.idListObserver.close();
          this.idListObserver = null;
          return;
        }
        if (this.idListObserver)
          return;
        this.idListObserver = new ObjectObserver(this.idList);
        var THIS = this;
        this.idListObserver.open(function(added, removed, changed, getOldValue) {
          console.log('idList changed');
          THIS.forceRefilter += 1;
        });
      },
      attributeChanged: function(name, oldVal, newVal) {
        console.log('attributeChanged', name, oldVal, newVal);
      }
    });
  </script>
</polymer-element>
<script>
(function() {
  window.addEventListener('polymer-ready', function(e) {
    Polymer.waitingFor(); // shows busted/unresolved elements
    var waitFor = Polymer.waitingFor();
    if (waitFor.length > 0)
      console.error("Unresolved elements", waitFor);
  })
});
</script>
